name: Tests

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  flutter-tests:
    name: Flutter Tests
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.27.0'
          channel: 'stable'
          cache: true

      - name: Install dependencies
        run: flutter pub get

      - name: Verify formatting
        run: dart format --output=none --set-exit-if-changed .

      - name: Analyze project source
        run: flutter analyze --no-fatal-infos

      - name: Run tests with coverage
        run: flutter test --coverage

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v4
        with:
          files: coverage/lcov.info
          fail_ci_if_error: false
          verbose: true
        env:
          CODECOV_TOKEN: ${{ secrets.CODECOV_TOKEN }}

  edge-function-tests:
    name: Edge Function Tests
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Deno
        uses: denoland/setup-deno@v1
        with:
          deno-version: v1.x

      - name: Cache Deno dependencies
        uses: actions/cache@v4
        with:
          path: ~/.cache/deno
          key: deno-${{ runner.os }}-${{ hashFiles('**/deno.json', '**/deno.lock') }}
          restore-keys: |
            deno-${{ runner.os }}-

      - name: Run Edge Function tests
        run: deno test --allow-env --allow-net supabase/functions/
        env:
          # Test environment variables (mocked values for testing)
          SUPABASE_URL: https://test.supabase.co
          SECRET_API_KEY: test-secret-api-key
          TWILIO_ACCOUNT_SID: test-twilio-sid
          TWILIO_AUTH_TOKEN: test-twilio-token
          TWILIO_PHONE_NUMBER: "+15555555555"
          RESEND_API_KEY: test-resend-key
          RESEND_FROM_EMAIL: test@example.com
          CRON_SECRET: test-cron-secret
          FCM_PROJECT_ID: test-project
          FCM_CLIENT_EMAIL: test@test.iam.gserviceaccount.com
          FCM_PRIVATE_KEY: test-private-key
